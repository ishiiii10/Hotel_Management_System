<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">notification-service</a> &gt; <a href="index.source.html" class="el_package">com.hotelbooking.notification.service</a> &gt; <span class="el_source">NotificationService.java</span></div><h1>NotificationService.java</h1><pre class="source lang-java linenums">package com.hotelbooking.notification.service;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.UUID;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.hotelbooking.notification.domain.ScheduledReminder;
import com.hotelbooking.notification.dto.BookingCancelledEvent;
import com.hotelbooking.notification.dto.BookingConfirmedEvent;
import com.hotelbooking.notification.dto.BookingCreatedEvent;
import com.hotelbooking.notification.dto.CheckoutCompletedEvent;
import com.hotelbooking.notification.dto.GuestCheckedInEvent;
import com.hotelbooking.notification.dto.HotelInfoResponse;
import com.hotelbooking.notification.feign.HotelServiceClient;
import com.hotelbooking.notification.repository.ScheduledReminderRepository;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Service
<span class="fc" id="L25">@RequiredArgsConstructor</span>
<span class="fc" id="L26">@Slf4j</span>
public class NotificationService {

    private final EmailService emailService;
    private final SmsService smsService;
    private final HotelServiceClient hotelServiceClient;
    private final ScheduledReminderRepository reminderRepository;

    @Value(&quot;${notification.feedback.base-url:http://localhost:3000/feedback}&quot;)
    private String feedbackBaseUrl;

    @Transactional
    public void handleBookingCreated(BookingCreatedEvent event) {
        try {
<span class="nc" id="L40">            log.info(&quot;Processing BookingCreatedEvent for bookingId: {}&quot;, event.getBookingId());</span>

            // Fetch hotel details
<span class="nc" id="L43">            HotelInfoResponse hotel = hotelServiceClient.getHotelById(event.getHotelId());</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">            if (hotel == null) {</span>
<span class="nc" id="L45">                log.warn(&quot;Hotel not found for hotelId: {}&quot;, event.getHotelId());</span>
<span class="nc" id="L46">                return;</span>
            }

<span class="nc bnc" id="L49" title="All 2 branches missed.">            String guestName = event.getGuestName() != null ? event.getGuestName() : &quot;Guest&quot;;</span>
<span class="nc" id="L50">            String guestEmail = event.getGuestEmail();</span>

<span class="nc bnc" id="L52" title="All 4 branches missed.">            if (guestEmail == null || guestEmail.isEmpty()) {</span>
<span class="nc" id="L53">                log.warn(&quot;Guest email missing for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L54">                return;</span>
            }

            // Send booking created email
<span class="nc" id="L58">            emailService.sendBookingConfirmationEmail(</span>
                guestEmail,
                guestName,
<span class="nc" id="L61">                hotel.getName(),</span>
<span class="nc" id="L62">                event.getCheckInDate().toString(),</span>
<span class="nc" id="L63">                event.getCheckOutDate().toString(),</span>
<span class="nc" id="L64">                event.getAmount()</span>
            );

            // Schedule check-in reminder (24 hours before check-in)
<span class="nc" id="L68">            scheduleCheckInReminder(event, hotel);</span>

<span class="nc" id="L70">            log.info(&quot;BookingCreatedEvent processed successfully for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L71">        } catch (Exception e) {</span>
<span class="nc" id="L72">            log.error(&quot;Error processing BookingCreatedEvent for bookingId: {}&quot;, </span>
<span class="nc" id="L73">                     event.getBookingId(), e);</span>
<span class="nc" id="L74">        }</span>
<span class="nc" id="L75">    }</span>

    @Transactional
    public void handleBookingConfirmed(BookingConfirmedEvent event) {
        try {
<span class="nc" id="L80">            log.info(&quot;Processing BookingConfirmedEvent for bookingId: {}&quot;, event.getBookingId());</span>

            // Fetch hotel details
<span class="nc" id="L83">            HotelInfoResponse hotel = hotelServiceClient.getHotelById(event.getHotelId());</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (hotel == null) {</span>
<span class="nc" id="L85">                log.warn(&quot;Hotel not found for hotelId: {}&quot;, event.getHotelId());</span>
<span class="nc" id="L86">                return;</span>
            }

<span class="nc bnc" id="L89" title="All 2 branches missed.">            String guestName = event.getGuestName() != null ? event.getGuestName() : &quot;Guest&quot;;</span>
<span class="nc" id="L90">            String guestEmail = event.getGuestEmail();</span>

<span class="nc bnc" id="L92" title="All 4 branches missed.">            if (guestEmail == null || guestEmail.isEmpty()) {</span>
<span class="nc" id="L93">                log.warn(&quot;Guest email missing for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L94">                return;</span>
            }

            // Send confirmation email
<span class="nc" id="L98">            emailService.sendBookingConfirmationEmail(</span>
                guestEmail,
                guestName,
<span class="nc" id="L101">                hotel.getName(),</span>
<span class="nc" id="L102">                event.getCheckInDate().toString(),</span>
<span class="nc" id="L103">                event.getCheckOutDate().toString(),</span>
<span class="nc" id="L104">                event.getAmount()</span>
            );

            // Schedule check-in reminder if not already scheduled
<span class="nc" id="L108">            scheduleCheckInReminder(event, hotel);</span>

<span class="nc" id="L110">            log.info(&quot;BookingConfirmedEvent processed successfully for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L111">        } catch (Exception e) {</span>
<span class="nc" id="L112">            log.error(&quot;Error processing BookingConfirmedEvent for bookingId: {}&quot;, </span>
<span class="nc" id="L113">                     event.getBookingId(), e);</span>
<span class="nc" id="L114">        }</span>
<span class="nc" id="L115">    }</span>

    @Transactional
    public void handleBookingCancelled(BookingCancelledEvent event) {
        try {
<span class="nc" id="L120">            log.info(&quot;Processing BookingCancelledEvent for bookingId: {}&quot;, event.getBookingId());</span>

            // Cancel scheduled reminders
<span class="nc" id="L123">            reminderRepository.findByBookingId(event.getBookingId())</span>
<span class="nc" id="L124">                .forEach(reminder -&gt; {</span>
<span class="nc" id="L125">                    reminder.setCancelled(true);</span>
<span class="nc" id="L126">                    reminderRepository.save(reminder);</span>
<span class="nc" id="L127">                });</span>

            // Fetch hotel details
<span class="nc" id="L130">            HotelInfoResponse hotel = hotelServiceClient.getHotelById(event.getHotelId());</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (hotel == null) {</span>
<span class="nc" id="L132">                log.warn(&quot;Hotel not found for hotelId: {}&quot;, event.getHotelId());</span>
<span class="nc" id="L133">                return;</span>
            }

<span class="nc bnc" id="L136" title="All 2 branches missed.">            String guestName = event.getGuestName() != null ? event.getGuestName() : &quot;Guest&quot;;</span>
<span class="nc" id="L137">            String guestEmail = event.getGuestEmail();</span>

<span class="nc bnc" id="L139" title="All 4 branches missed.">            if (guestEmail == null || guestEmail.isEmpty()) {</span>
<span class="nc" id="L140">                log.warn(&quot;Guest email missing for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L141">                return;</span>
            }

            // Send cancellation email
<span class="nc" id="L145">            emailService.sendCancellationEmail(</span>
                guestEmail,
                guestName,
<span class="nc" id="L148">                hotel.getName(),</span>
<span class="nc" id="L149">                event.getCheckInDate().toString(),</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                event.getCancellationReason() != null ? event.getCancellationReason() : &quot;Not specified&quot;</span>
            );

<span class="nc" id="L153">            log.info(&quot;BookingCancelledEvent processed successfully for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L154">        } catch (Exception e) {</span>
<span class="nc" id="L155">            log.error(&quot;Error processing BookingCancelledEvent for bookingId: {}&quot;, </span>
<span class="nc" id="L156">                     event.getBookingId(), e);</span>
<span class="nc" id="L157">        }</span>
<span class="nc" id="L158">    }</span>

    @Transactional
    public void handleGuestCheckedIn(GuestCheckedInEvent event) {
        try {
<span class="nc" id="L163">            log.info(&quot;Processing GuestCheckedInEvent for bookingId: {}&quot;, event.getBookingId());</span>

            // Fetch hotel details
<span class="nc" id="L166">            HotelInfoResponse hotel = hotelServiceClient.getHotelById(event.getHotelId());</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (hotel == null) {</span>
<span class="nc" id="L168">                log.warn(&quot;Hotel not found for hotelId: {}&quot;, event.getHotelId());</span>
<span class="nc" id="L169">                return;</span>
            }

<span class="nc bnc" id="L172" title="All 2 branches missed.">            String guestName = event.getGuestName() != null ? event.getGuestName() : &quot;Guest&quot;;</span>
<span class="nc" id="L173">            String guestEmail = event.getGuestEmail();</span>

<span class="nc bnc" id="L175" title="All 4 branches missed.">            if (guestEmail == null || guestEmail.isEmpty()) {</span>
<span class="nc" id="L176">                log.warn(&quot;Guest email missing for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L177">                return;</span>
            }

            // Send welcome email
<span class="nc" id="L181">            emailService.sendCheckInNotificationEmail(</span>
                guestEmail,
                guestName,
<span class="nc" id="L184">                hotel.getName(),</span>
<span class="nc" id="L185">                event.getCheckInDate().toString()</span>
            );

            // Cancel any pending reminders (guest already checked in)
<span class="nc" id="L189">            reminderRepository.findByBookingId(event.getBookingId())</span>
<span class="nc" id="L190">                .forEach(reminder -&gt; {</span>
<span class="nc" id="L191">                    reminder.setCancelled(true);</span>
<span class="nc" id="L192">                    reminderRepository.save(reminder);</span>
<span class="nc" id="L193">                });</span>

<span class="nc" id="L195">            log.info(&quot;GuestCheckedInEvent processed successfully for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L196">        } catch (Exception e) {</span>
<span class="nc" id="L197">            log.error(&quot;Error processing GuestCheckedInEvent for bookingId: {}&quot;, </span>
<span class="nc" id="L198">                     event.getBookingId(), e);</span>
<span class="nc" id="L199">        }</span>
<span class="nc" id="L200">    }</span>

    @Transactional
    public void handleCheckoutCompleted(CheckoutCompletedEvent event) {
        try {
<span class="nc" id="L205">            log.info(&quot;Processing CheckoutCompletedEvent for bookingId: {}&quot;, event.getBookingId());</span>

            // Fetch hotel details
<span class="nc" id="L208">            HotelInfoResponse hotel = hotelServiceClient.getHotelById(event.getHotelId());</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (hotel == null) {</span>
<span class="nc" id="L210">                log.warn(&quot;Hotel not found for hotelId: {}&quot;, event.getHotelId());</span>
<span class="nc" id="L211">                return;</span>
            }

<span class="nc bnc" id="L214" title="All 2 branches missed.">            String guestName = event.getGuestName() != null ? event.getGuestName() : &quot;Guest&quot;;</span>
<span class="nc" id="L215">            String guestEmail = event.getGuestEmail();</span>

<span class="nc bnc" id="L217" title="All 4 branches missed.">            if (guestEmail == null || guestEmail.isEmpty()) {</span>
<span class="nc" id="L218">                log.warn(&quot;Guest email missing for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L219">                return;</span>
            }

            // Send thank-you email
<span class="nc" id="L223">            emailService.sendBookingCompletedEmail(</span>
                guestEmail,
                guestName,
<span class="nc" id="L226">                hotel.getName()</span>
            );

            // Generate feedback link (booking-scoped and time-limited)
<span class="nc" id="L230">            String feedbackToken = UUID.randomUUID().toString();</span>
<span class="nc" id="L231">            String feedbackLink = String.format(&quot;%s?token=%s&amp;bookingId=%d&quot;, </span>
<span class="nc" id="L232">                feedbackBaseUrl, feedbackToken, event.getBookingId());</span>

            // Send feedback request email
<span class="nc" id="L235">            emailService.sendFeedbackRequestEmail(</span>
                guestEmail,
                guestName,
<span class="nc" id="L238">                hotel.getName(),</span>
<span class="nc" id="L239">                event.getBookingId(),</span>
                feedbackLink
            );

<span class="nc" id="L243">            log.info(&quot;CheckoutCompletedEvent processed successfully for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L244">        } catch (Exception e) {</span>
<span class="nc" id="L245">            log.error(&quot;Error processing CheckoutCompletedEvent for bookingId: {}&quot;, </span>
<span class="nc" id="L246">                     event.getBookingId(), e);</span>
<span class="nc" id="L247">        }</span>
<span class="nc" id="L248">    }</span>

    private void scheduleCheckInReminder(BookingCreatedEvent event, HotelInfoResponse hotel) {
        try {
            // Check if reminder already exists
<span class="nc" id="L253">            if (reminderRepository.findByBookingIdAndReminderType(</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                    event.getBookingId(), &quot;CHECK_IN_REMINDER&quot;).isPresent()) {</span>
<span class="nc" id="L255">                log.debug(&quot;Check-in reminder already scheduled for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L256">                return;</span>
            }

            // Schedule reminder 24 hours before check-in
<span class="nc" id="L260">            LocalDate reminderDate = event.getCheckInDate().minusDays(1);</span>

<span class="nc" id="L262">            ScheduledReminder reminder = ScheduledReminder.builder()</span>
<span class="nc" id="L263">                .bookingId(event.getBookingId())</span>
<span class="nc" id="L264">                .userId(event.getUserId())</span>
<span class="nc" id="L265">                .hotelId(event.getHotelId())</span>
<span class="nc" id="L266">                .reminderType(&quot;CHECK_IN_REMINDER&quot;)</span>
<span class="nc" id="L267">                .scheduledDate(reminderDate)</span>
<span class="nc" id="L268">                .checkInDate(event.getCheckInDate())</span>
<span class="nc" id="L269">                .guestEmail(event.getGuestEmail())</span>
<span class="nc" id="L270">                .guestName(event.getGuestName())</span>
<span class="nc" id="L271">                .sent(false)</span>
<span class="nc" id="L272">                .cancelled(false)</span>
<span class="nc" id="L273">                .build();</span>

<span class="nc" id="L275">            reminderRepository.save(reminder);</span>
<span class="nc" id="L276">            log.info(&quot;Scheduled check-in reminder for bookingId: {} on date: {}&quot;, </span>
<span class="nc" id="L277">                    event.getBookingId(), reminderDate);</span>
<span class="nc" id="L278">        } catch (Exception e) {</span>
<span class="nc" id="L279">            log.error(&quot;Failed to schedule check-in reminder for bookingId: {}&quot;, </span>
<span class="nc" id="L280">                     event.getBookingId(), e);</span>
<span class="nc" id="L281">        }</span>
<span class="nc" id="L282">    }</span>

    private void scheduleCheckInReminder(BookingConfirmedEvent event, HotelInfoResponse hotel) {
        try {
            // Check if reminder already exists
<span class="nc" id="L287">            if (reminderRepository.findByBookingIdAndReminderType(</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">                    event.getBookingId(), &quot;CHECK_IN_REMINDER&quot;).isPresent()) {</span>
<span class="nc" id="L289">                log.debug(&quot;Check-in reminder already scheduled for bookingId: {}&quot;, event.getBookingId());</span>
<span class="nc" id="L290">                return;</span>
            }

            // Schedule reminder 24 hours before check-in
<span class="nc" id="L294">            LocalDate reminderDate = event.getCheckInDate().minusDays(1);</span>

<span class="nc" id="L296">            ScheduledReminder reminder = ScheduledReminder.builder()</span>
<span class="nc" id="L297">                .bookingId(event.getBookingId())</span>
<span class="nc" id="L298">                .userId(event.getUserId())</span>
<span class="nc" id="L299">                .hotelId(event.getHotelId())</span>
<span class="nc" id="L300">                .reminderType(&quot;CHECK_IN_REMINDER&quot;)</span>
<span class="nc" id="L301">                .scheduledDate(reminderDate)</span>
<span class="nc" id="L302">                .checkInDate(event.getCheckInDate())</span>
<span class="nc" id="L303">                .guestEmail(event.getGuestEmail())</span>
<span class="nc" id="L304">                .guestName(event.getGuestName())</span>
<span class="nc" id="L305">                .sent(false)</span>
<span class="nc" id="L306">                .cancelled(false)</span>
<span class="nc" id="L307">                .build();</span>

<span class="nc" id="L309">            reminderRepository.save(reminder);</span>
<span class="nc" id="L310">            log.info(&quot;Scheduled check-in reminder for bookingId: {} on date: {}&quot;, </span>
<span class="nc" id="L311">                    event.getBookingId(), reminderDate);</span>
<span class="nc" id="L312">        } catch (Exception e) {</span>
<span class="nc" id="L313">            log.error(&quot;Failed to schedule check-in reminder for bookingId: {}&quot;, </span>
<span class="nc" id="L314">                     event.getBookingId(), e);</span>
<span class="nc" id="L315">        }</span>
<span class="nc" id="L316">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>